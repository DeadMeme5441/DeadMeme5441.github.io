---
import { type CollectionEntry, getCollection } from 'astro:content';
import BaseHead from '../../components/BaseHead.astro';
import Footer from '../../components/Footer.astro';
import FormattedDate from '../../components/FormattedDate.astro';
import Header from '../../components/Header.astro';
import { SITE_DESCRIPTION, SITE_TITLE } from '../../consts';

const entries = (await getCollection('thoughtsAndOpinions'))
	.filter(({ data }) => !data.draft)
	.sort((a, b) => {
		const aDate = a.data.updatedDate ?? a.data.pubDate;
		const bDate = b.data.updatedDate ?? b.data.pubDate;
		return bDate.valueOf() - aDate.valueOf();
	});

const entry = entries[0] as CollectionEntry<'thoughtsAndOpinions'> | undefined;
const rendered = entry ? await entry.render() : undefined;
const lastUpdated = entry ? entry.data.updatedDate ?? entry.data.pubDate : undefined;
---

<!doctype html>
<html lang="en">
	<head>
		<BaseHead
			title={entry ? `${SITE_TITLE} — ${entry.data.title}` : `${SITE_TITLE} — Thoughts & Opinions`}
			description={entry?.data.description ?? SITE_DESCRIPTION}
		/>
		<style>
			main {
				width: min(760px, calc(100% - 2rem));
				margin: 0 auto;
				padding: 2rem 0;
				color: rgb(var(--gray-dark));
			}
			header {
				margin-bottom: 2rem;
				text-align: center;
			}
			h1 {
				margin-bottom: 0.5rem;
			}
			.meta {
				color: rgb(var(--gray));
			}
		</style>
	</head>
	<body>
		<Header />
		<main>
			{entry ? (
				<>
					<header>
						<h1>{entry.data.title}</h1>
						{lastUpdated && (
							<div class="meta">
								Last updated: <FormattedDate date={lastUpdated} />
							</div>
						)}
					</header>
					<article>
						{rendered && <rendered.Content />}
					</article>
				</>
			) : (
				<section>
					<h1>Thoughts & Opinions</h1>
					<p>No entry has been published yet. Export from Org to create one.</p>
				</section>
			)}
		</main>
		<Footer />
	</body>
</html>

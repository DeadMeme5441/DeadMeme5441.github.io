---
import { getCollection } from 'astro:content';
import BaseHead from '../../components/BaseHead.astro';
import Footer from '../../components/Footer.astro';
import FormattedDate from '../../components/FormattedDate.astro';
import Header from '../../components/Header.astro';
import { SITE_DESCRIPTION, SITE_TITLE } from '../../consts';

const CATEGORY_LABELS = {
	websites: 'Websites',
	'twitter-posts': 'Tweets',
	videos: 'Videos',
	books: 'Books',
	articles: 'Articles',
	podcasts: 'Podcasts',
	other: 'Miscellaneous',
} as const;

const entries = (await getCollection('interestingStuff'))
	.filter(({ data }) => !data.draft)
	.sort((a, b) => b.data.pubDate.valueOf() - a.data.pubDate.valueOf());

const categoryOrder = Object.keys(CATEGORY_LABELS) as (keyof typeof CATEGORY_LABELS)[];
const grouped = new Map<keyof typeof CATEGORY_LABELS, typeof entries>(
	categoryOrder.map((key) => [key, [] as typeof entries]),
);
entries.forEach((entry) => {
	const key = entry.data.category as keyof typeof CATEGORY_LABELS;
	const bucket = grouped.get(key);
	if (bucket) bucket.push(entry);
});
const hasEntries = entries.length > 0;
---

<!doctype html>
<html lang="en">
	<head>
		<BaseHead title={`${SITE_TITLE} — Interesting Stuff`} description={SITE_DESCRIPTION} />
		<style>
			main {
				width: min(960px, calc(100% - 2rem));
				margin: 0 auto;
				padding: 2rem 0;
			}
			.section {
				margin-bottom: 3rem;
			}
			.section h2 {
				margin-bottom: 1rem;
			}
			.items {
				display: grid;
				grid-template-columns: repeat(auto-fit, minmax(260px, 1fr));
				gap: 1.5rem;
				list-style: none;
				padding: 0;
				margin: 0;
			}
			.item {
				border: 1px solid rgba(var(--gray), 0.25);
				border-radius: 12px;
				padding: 1rem;
				background: rgba(var(--white), 0.75);
				display: flex;
				flex-direction: column;
				gap: 0.5rem;
			}
			.item h3 {
				margin: 0;
				font-size: 1.125rem;
			}
			.item p {
				margin: 0;
				color: rgb(var(--gray));
			}
			.meta {
				display: flex;
				flex-wrap: wrap;
				gap: 0.5rem;
				align-items: baseline;
				color: rgb(var(--gray));
				font-size: 0.875rem;
			}
			.tags {
				display: flex;
				flex-wrap: wrap;
				gap: 0.5rem;
				margin: 0.5rem 0 0;
				padding: 0;
				list-style: none;
			}
			.tag {
				background: rgba(var(--accent), 0.12);
				color: rgb(var(--accent));
				border-radius: 999px;
				padding: 0.25rem 0.75rem;
				font-size: 0.75rem;
			}
			.link {
				color: rgb(var(--accent));
				text-decoration: underline;
			}
		</style>
	</head>
	<body>
		<Header />
		<main>
			{hasEntries ? (
				Array.from(grouped.entries())
					.filter(([, bucket]) => bucket.length > 0)
					.map(([key, bucket]) => (
						<section class="section" id={key}>
							<h2>{CATEGORY_LABELS[key]}</h2>
							<ul class="items">
								{bucket.map((entry) => (
									<li class="item">
										<h3>
											{entry.data.link ? (
												<a class="link" href={entry.data.link} target="_blank" rel="noopener noreferrer">
													{entry.data.title}
												</a>
											) : (
												<a class="link" href={`/interesting-stuff/${entry.id}/`}>{entry.data.title}</a>
											)}
										</h3>
										<div class="meta">
											<FormattedDate date={entry.data.pubDate} />
											{entry.data.link && <span aria-hidden="true">•</span>}
											{entry.data.link && <span>External link</span>}
										</div>
										{entry.data.description && <p>{entry.data.description}</p>}
										{entry.data.tags.length > 0 && (
											<ul class="tags">
												{entry.data.tags.map((tag) => (
													<li class="tag">{tag}</li>
												))}
											</ul>
										)}
									</li>
								))}
							</ul>
						</section>
					))
			) : (
				<p>No links yet—export an item from Org to populate this page.</p>
			)}
		</main>
		<Footer />
	</body>
</html>
